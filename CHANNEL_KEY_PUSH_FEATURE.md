# Channel Keyæ¨é€åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

åœ¨åˆ é™¤GCloudè´¦æˆ·æ—¶ï¼Œè‡ªåŠ¨å°†è¯¥è´¦æˆ·åœ¨Azure MySQLæ•°æ®åº“ä¸­å¯¹åº”çš„æ‰€æœ‰channel keysæ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨è¿›è¡Œå¤‡ä»½ä¿å­˜ã€‚

## æŠ€æœ¯æ¶æ„

### 1. æ•°æ®æº
- **æ•°æ®åº“**: Azure MySQL (chatify-database.mysql.database.azure.com)
- **æ•°æ®åº“å**: vertex_ai_pool_1
- **è¡¨å**: channels
- **å…³é”®å­—æ®µ**: id, name, key

### 2. æ¨é€ç›®æ ‡
- **APIç«¯ç‚¹**: http://104.243.32.237:10000/api/add
- **è¯·æ±‚æ–¹å¼**: POST
- **Content-Type**: application/json
- **è¯·æ±‚ä½“**: ç›´æ¥ä¼ é€’keyå­—ç¬¦ä¸²

### 3. æ ¸å¿ƒæœåŠ¡

#### ChannelKeyService (`backend/services/channelKeyService.js`)

**ä¸»è¦æ–¹æ³•**:

1. **getChannelKeysByEmail(accountEmail)**
   - ä»MySQLæ•°æ®åº“æŸ¥è¯¢åŒ¹é…é‚®ç®±çš„æ‰€æœ‰channels
   - åŒ¹é…è§„åˆ™: `name LIKE '%{email}%'`
   - è¿”å›: channelsæ•°ç»„ï¼ˆåŒ…å«id, name, keyï¼‰

2. **pushKeyWithRetry(key, channelId, channelName)**
   - æ¨é€å•ä¸ªkeyåˆ°è¿œç¨‹æœåŠ¡å™¨
   - è‡ªåŠ¨é‡è¯•3æ¬¡ï¼ˆå¤±è´¥æ—¶ï¼‰
   - é‡è¯•é—´éš”: 1ç§’ã€2ç§’ã€3ç§’ï¼ˆé€’å¢ï¼‰
   - è¿”å›: æ¨é€ç»“æœå¯¹è±¡

3. **pushAccountKeys(accountEmail, progressCallback)**
   - æ‰¹é‡æ¨é€è´¦æˆ·çš„æ‰€æœ‰keys
   - ä¸²è¡Œå¤„ç†ï¼ˆé¿å…å¹¶å‘å‹åŠ›ï¼‰
   - å®æ—¶è¿›åº¦å›è°ƒ
   - æ¨é€é—´éš”: 200ms
   - è¿”å›: æ±‡æ€»ç»“æœ

## é›†æˆåˆ°åˆ é™¤æµç¨‹

### æ‰§è¡Œé¡ºåº

```
è´¦æˆ·åˆ é™¤æµç¨‹:
1. æ•°æ®åŒæ­¥ï¼ˆAccountSummaryè¡¨ï¼‰
2. æ¨é€Channel Keys â¬…ï¸ æ–°å¢æ­¥éª¤
3. åˆ é™¤OneAPIæ¸ é“
4. åˆ é™¤GCloudè´¦æˆ·
5. æ’¤é”€è®¤è¯
```

### SSEäº‹ä»¶ç±»å‹

**æ–°å¢çš„äº‹ä»¶ç±»å‹**:
- `keys_pushing`: å¼€å§‹æ¨é€keys
- `keys_start`: keysæ¨é€å¼€å§‹
- `keys_progress`: keysæ¨é€è¿›åº¦æ›´æ–°
- `keys_completed`: keysæ¨é€å®Œæˆ
- `keys_pushed`: è´¦æˆ·keysæ¨é€æ€»ç»“
- `keys_push_failed`: keysæ¨é€å¤±è´¥ï¼ˆç»§ç»­åˆ é™¤æµç¨‹ï¼‰

### ä»£ç ä½ç½®

- **æœåŠ¡**: `/root/gcloud_server/backend/services/channelKeyService.js`
- **è·¯ç”±é›†æˆ**: `/root/gcloud_server/backend/routes/gcloud-accounts.js` (ç¬¬857-894è¡Œ)

## é”™è¯¯å¤„ç†

### é‡è¯•æœºåˆ¶
- **æœ€å¤§é‡è¯•æ¬¡æ•°**: 3æ¬¡
- **é‡è¯•ç­–ç•¥**: æŒ‡æ•°é€€é¿ï¼ˆ1s, 2s, 3sï¼‰
- **å¤±è´¥å¤„ç†**: è®°å½•æ—¥å¿—ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªkey

### å®¹é”™è®¾è®¡
- Keyæ¨é€å¤±è´¥ä¸å½±å“åç»­çš„æ¸ é“åˆ é™¤æµç¨‹
- æ¨é€é”™è¯¯ä¼šè®°å½•åˆ°æ—¥å¿—å¹¶é€šè¿‡SSEé€šçŸ¥å‰ç«¯
- æ•°æ®åº“è¿æ¥å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸ä½†ä¸ä¸­æ–­æ•´ä½“åˆ é™¤æµç¨‹

## æµ‹è¯•

### æµ‹è¯•è„šæœ¬

1. **æµ‹è¯•MySQLè¿æ¥**: `node test-mysql-connection.js`
2. **æµ‹è¯•å•ä¸ªkeyæ¨é€**: `node test-push-key.js`
3. **æµ‹è¯•å®Œæ•´æœåŠ¡**: `node test-channel-key-service.js`

### æµ‹è¯•ç»“æœç¤ºä¾‹

```bash
âœ… æµ‹è¯•å®Œæˆï¼

ğŸ“‹ ç»“æœæ±‡æ€»:
   æ€»æ¸ é“æ•°: 6
   æˆåŠŸæ¨é€: 6
   å¤±è´¥æ•°é‡: 0

è¯¦ç»†ç»“æœ:
   1. âœ… Channel 4150 - martinezwilliametrcu1387@gmail.com-075237_suspend
   2. âœ… Channel 4151 - martinezwilliametrcu1387@gmail.com-075237_suspend
   ...
```

## æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–æªæ–½
- **ä¸²è¡Œå¤„ç†**: é¿å…å¹¶å‘è¯·æ±‚è¿‡å¤šå¯¼è‡´APIé™æµ
- **è¯·æ±‚é—´éš”**: æ¯ä¸ªkeyæ¨é€åç­‰å¾…200ms
- **è¶…æ—¶è®¾ç½®**: æ¯ä¸ªè¯·æ±‚è¶…æ—¶æ—¶é—´10ç§’
- **è¿æ¥æ± **: MySQLä½¿ç”¨è¿æ¥æ± é¿å…é¢‘ç¹å»ºç«‹è¿æ¥

### é¢„æœŸæ€§èƒ½
- å•ä¸ªkeyæ¨é€: ~200-500ms
- 100ä¸ªkeysæ¨é€: ~20-50ç§’
- é‡è¯•å¼€é”€: å¤±è´¥æ—¶é¢å¤–1-6ç§’

## æ•°æ®åº“é…ç½®

```javascript
{
  host: 'chatify-database.mysql.database.azure.com',
  user: 'database',
  password: 'sk-chatify-MoLu154!',
  database: 'vertex_ai_pool_1',
  port: 3306
}
```

## APIå“åº”æ ¼å¼

### æˆåŠŸå“åº” (200)
```json
{
  "added": 1,
  "group": "",
  "ids": [262342]
}
```

### å¤±è´¥å“åº”
- çŠ¶æ€ç : é200
- ä¼šè§¦å‘è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰

## æ—¥å¿—è®°å½•

### æ—¥å¿—çº§åˆ«
- **INFO**: è¿æ¥æˆåŠŸã€æ¨é€æˆåŠŸã€å®Œæˆæ±‡æ€»
- **WARN**: é‡è¯•è­¦å‘Šã€æ¨é€å¤±è´¥
- **ERROR**: æ•°æ®åº“è¿æ¥å¤±è´¥ã€APIé”™è¯¯

### æ—¥å¿—ç¤ºä¾‹
```
info: Starting to push keys for account: test@gmail.com
info: Found 6 channels for email: test@gmail.com
info: Pushing key for channel 4150 (attempt 1/3)
info: âœ… Successfully pushed key for channel 4150
info: Completed pushing keys: 6 success, 0 failed
```

## å‰ç«¯æ˜¾ç¤º

åˆ é™¤æµç¨‹ä¸­ä¼šå®æ—¶æ˜¾ç¤ºï¼š
- "å¼€å§‹æ¨é€channel keys..."
- "Keysæ¨é€è¿›åº¦: 3/6 (50%)"
- "Keysæ¨é€å®Œæˆ (6æˆåŠŸ, 0å¤±è´¥)"

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åŒ¹é…**: ä½¿ç”¨é‚®ç®±æ¨¡ç³ŠåŒ¹é…ï¼Œå¯èƒ½åŒ¹é…åˆ°å¤šä¸ªchannel
2. **ç½‘ç»œä¾èµ–**: ä¾èµ–Azure MySQLå’Œè¿œç¨‹APIçš„ç½‘ç»œè¿é€šæ€§
3. **é¡ºåºä¿è¯**: æ¨é€å®Œkeysåæ‰ä¼šåˆ é™¤æ¸ é“ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
4. **å¤±è´¥ç»§ç»­**: å³ä½¿keyæ¨é€å¤±è´¥ï¼Œåˆ é™¤æµç¨‹ä»ä¼šç»§ç»­æ‰§è¡Œ

## æœªæ¥æ”¹è¿›å»ºè®®

1. **æ‰¹é‡æ¨é€**: æ”¹ä¸ºæ‰¹é‡APIè°ƒç”¨æé«˜æ€§èƒ½
2. **æ–­ç‚¹ç»­ä¼ **: æ¨é€å¤±è´¥æ—¶è®°å½•ä½ç½®ï¼Œæ”¯æŒé‡æ–°æ¨é€
3. **æ¨é€éªŒè¯**: æ¨é€åéªŒè¯è¿œç¨‹æœåŠ¡å™¨æ˜¯å¦çœŸçš„æ¥æ”¶åˆ°
4. **å¤‡ä»½æ—¥å¿—**: å°†æ¨é€ç»“æœä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä½œä¸ºå¤‡ä»½
