<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸ é“ç»Ÿè®¡åˆ†æ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .time-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid #007bff;
        }

        .time-filter label {
            font-weight: 600;
            color: #495057;
        }

        .time-filter input {
            width: 80px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }

        .time-filter span {
            color: #6c757d;
            font-weight: 500;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        .batch-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .batch-select-all {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: 600;
            cursor: pointer;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .progress-container {
            max-width: 400px;
            margin: 20px auto;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 3px;
            display: none;
        }

        .progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 8px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        .fetch-status {
            max-width: 500px;
            margin: 15px auto;
            padding: 12px 20px;
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            text-align: center;
        }

        .fetch-text {
            font-size: 14px;
            color: #0c5460;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 5px solid #007bff;
        }

        .stat-card h3 {
            color: #007bff;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .stat-card p {
            color: #666;
            font-size: 1.1em;
            font-weight: 500;
        }

        .accounts-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .table-header h2 {
            color: #495057;
            font-size: 1.5em;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .email-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #007bff;
            max-width: 200px;
            word-break: break-all;
        }

        .amount-cell {
            font-weight: 700;
            color: #28a745;
            font-size: 1.1em;
        }

        .channels-cell {
            font-size: 0.9em;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
            margin: 2px;
        }

        .status-enabled {
            background-color: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-suspended {
            background-color: #fff3cd;
            color: #856404;
        }

        .metadata {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metadata h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .metadata-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .metadata-item strong {
            color: #495057;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .controls {
                justify-content: center;
            }

            .stats-overview {
                grid-template-columns: 1fr;
            }

            th, td {
                padding: 10px 8px;
                font-size: 14px;
            }

            .email-cell {
                max-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ¸ é“ç»Ÿè®¡åˆ†æ</h1>
            <p>åŸºäºæŒ‡å®šæ—¶é—´å‰åˆ›å»ºçš„æ¸ é“è¿›è¡Œé…é¢ä½¿ç”¨åˆ†æ</p>
        </div>

        <div class="controls">
            <div class="time-filter">
                <label for="timeHours">æ—¶é—´èŒƒå›´:</label>
                <input type="number" id="timeHours" min="1" max="168" value="10" step="1">
                <span>å°æ—¶å‰</span>
            </div>
            <button class="btn btn-primary" onclick="loadStats()">ğŸ”„ è·å–æ•°æ®</button>
            <button class="btn btn-success" onclick="exportToExcel()" id="exportBtn" disabled>ğŸ“Š å¯¼å‡ºExcel</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p id="mainStatusText">æ­£åœ¨åˆ†ææ¸ é“æ•°æ®...</p>

            <!-- æ•´ä½“è¿›åº¦æ¡ -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
                <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            </div>

            <!-- é¡µé¢è·å–è¿›åº¦ -->
            <div class="fetch-status" id="fetchStatus" style="display: none;">
                <div class="fetch-text" id="fetchText">æ­£åœ¨è·å–æ•°æ®...</div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="stats-overview" id="statsOverview"></div>

            <div class="accounts-table">
                <div class="table-header">
                    <h2>ğŸ“§ é‚®ç®±è´¦æˆ·è¯¦æƒ…</h2>
                    <div class="batch-controls" style="margin-top: 15px;" id="batchControls">
                        <label class="batch-select-all">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> å…¨é€‰
                        </label>
                        <button class="btn btn-danger" onclick="batchDelete()" id="batchDeleteBtn" disabled style="margin-left: 15px;">ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤é€‰ä¸­æ¸ é“</button>
                        <span id="selectedCount" style="margin-left: 15px; color: #666;">å·²é€‰æ‹©: 0 ä¸ªè´¦æˆ·</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>é€‰æ‹©</th>
                                <th>é‚®ç®±åœ°å€</th>
                                <th>æ€»é‡‘é¢ ($)</th>
                                <th>æ¸ é“æ€»æ•°</th>
                                <th>ä½¿ç”¨é…é¢</th>
                                <th>åˆ›å»ºæ—¶é—´èŒƒå›´</th>
                            </tr>
                        </thead>
                        <tbody id="accountsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="metadata" id="metadata"></div>
        </div>
    </div>

    <script>
        let currentData = null;

        async function loadStats() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const content = document.getElementById('content');

            // è·å–æ—¶é—´å‚æ•°
            const timeHours = document.getElementById('timeHours').value || 10;

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            // æ›´æ–°åŠ è½½æ¶ˆæ¯å’Œè¿›åº¦æ¡
            const mainStatusText = document.getElementById('mainStatusText');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const fetchStatus = document.getElementById('fetchStatus');
            const fetchText = document.getElementById('fetchText');

            mainStatusText.textContent = 'æ­£åœ¨åˆ†ææ¸ é“æ•°æ®...';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = 'åˆå§‹åŒ–...';
            fetchStatus.style.display = 'none';

            try {
                // ä½¿ç”¨æµå¼APIï¼Œä¼ é€’æ—¶é—´å‚æ•°ï¼ˆæ¯æ¬¡éƒ½é‡æ–°è·å–ï¼‰
                const eventSource = new EventSource(`/api/stats/overview-stream?hours=${timeHours}`);

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);

                        switch(data.type) {
                            case 'connected':
                                mainStatusText.textContent = data.message;
                                progressText.textContent = 'è¿æ¥å·²å»ºç«‹';
                                progressBar.style.width = '5%';
                                break;


                            case 'start':
                                mainStatusText.textContent = data.message;
                                progressText.textContent = 'å¼€å§‹åˆ†æ';
                                progressBar.style.width = '10%';
                                fetchStatus.style.display = 'block';
                                fetchText.textContent = 'å‡†å¤‡è·å–æ¸ é“æ•°æ®...';
                                break;

                            case 'progress':
                                const stepText = data.step ? `æ­¥éª¤ ${data.step}/${data.totalSteps}` : '';
                                mainStatusText.textContent = data.message;

                                // æ›´æ–°æ•´ä½“è¿›åº¦æ¡ (åªåœ¨éè·å–é˜¶æ®µ)
                                if (data.step && data.totalSteps && data.step > 1) {
                                    const progressPercent = Math.round((data.step / data.totalSteps) * 90) + 5; // 5-95%
                                    progressBar.style.width = progressPercent + '%';
                                    progressText.textContent = stepText;
                                }
                                break;

                            case 'fetch_progress':
                                // åªåœ¨è·å–è¿›åº¦åŒºåŸŸæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                                const fetchInfo = data.fetchInfo;

                                if (fetchInfo && fetchInfo.type === 'fetch_start') {
                                    fetchStatus.style.display = 'block';
                                    fetchText.textContent = 'å¼€å§‹è·å–æ¸ é“æ•°æ®...';
                                    progressText.textContent = 'è·å–æ¸ é“æ•°æ®ä¸­';
                                } else if (fetchInfo && fetchInfo.type === 'fetch_page') {
                                    fetchText.textContent = `ğŸ“„ æ­£åœ¨è·å–ç¬¬ ${fetchInfo.page} é¡µæ•°æ®...`;
                                } else if (fetchInfo && fetchInfo.type === 'fetch_progress') {
                                    fetchText.textContent = `ğŸ“Š ç¬¬ ${fetchInfo.page} é¡µå®Œæˆ: +${fetchInfo.currentPageChannels} ä¸ªæ¸ é“ (ç´¯è®¡ ${fetchInfo.totalChannels})`;

                                    // ä¼°ç®—è·å–è¿›åº¦ (10-70%)
                                    const estimatedProgress = Math.min(10 + (fetchInfo.page / 12) * 60, 70);
                                    progressBar.style.width = estimatedProgress + '%';
                                } else if (fetchInfo && fetchInfo.type === 'fetch_complete') {
                                    fetchText.textContent = `âœ… æ•°æ®è·å–å®Œæˆï¼å…±è·å– ${fetchInfo.totalChannels} ä¸ªæ¸ é“`;
                                    progressBar.style.width = '70%';
                                    progressText.textContent = 'æ•°æ®è·å–å®Œæˆ';
                                }
                                break;

                            case 'database_saved':
                                progressBar.style.width = '95%';
                                progressText.textContent = 'æ•°æ®åº“ä¿å­˜ä¸­';
                                fetchText.textContent = data.message;
                                break;

                            case 'database_error':
                                progressText.textContent = 'æ•°æ®åº“ä¿å­˜å¤±è´¥';
                                fetchText.textContent = data.message;
                                break;

                            case 'complete':
                                mainStatusText.textContent = data.message;
                                progressText.textContent = 'åˆ†æå®Œæˆï¼';
                                progressBar.style.width = '100%';
                                fetchStatus.style.display = 'none';
                                break;

                            case 'result':
                                // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                                currentData = data.data;
                                displayStats(data.data);
                                loading.style.display = 'none';
                                content.style.display = 'block';

                                // å¯ç”¨å¯¼å‡ºæŒ‰é’®
                                document.getElementById('exportBtn').disabled = false;

                                eventSource.close();
                                break;

                            case 'error':
                                throw new Error(data.message || 'åˆ†æå¤±è´¥');
                        }
                    } catch (parseError) {
                        console.error('Error parsing SSE data:', parseError);
                        loadingText.textContent = 'æ•°æ®è§£æé”™è¯¯...';
                    }
                };

                eventSource.onerror = function(err) {
                    console.error('SSE Error:', err);
                    eventSource.close();
                    loading.style.display = 'none';
                    error.style.display = 'block';
                    error.textContent = 'è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢é‡è¯•';
                };

                // è¶…æ—¶å¤„ç†
                setTimeout(() => {
                    if (eventSource.readyState === EventSource.CONNECTING || eventSource.readyState === EventSource.OPEN) {
                        console.warn('SSE timeout, closing connection');
                        eventSource.close();
                        loading.style.display = 'none';
                        error.style.display = 'block';
                        error.textContent = 'è¯·æ±‚è¶…æ—¶ï¼Œæ•°æ®é‡è¾ƒå¤§ï¼Œè¯·ç¨åé‡è¯•';
                    }
                }, 120000); // 2åˆ†é’Ÿè¶…æ—¶

            } catch (err) {
                console.error('Error loading stats:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `é”™è¯¯: ${err.message}`;
            }
        }


        function displayStats(data) {
            displayOverview(data.totalStats);
            displayAccountsTable(data.accounts);
            displayMetadata(data.metadata);
        }

        function displayOverview(stats) {
            const overview = document.getElementById('statsOverview');
            overview.innerHTML = `
                <div class="stat-card">
                    <h3>${stats.totalAccounts}</h3>
                    <p>æ€»è´¦æˆ·æ•°</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.totalChannels}</h3>
                    <p>æ€»æ¸ é“æ•°</p>
                </div>
                <div class="stat-card">
                    <h3>$${stats.totalAmount.toFixed(2)}</h3>
                    <p>æ€»ä½¿ç”¨é‡‘é¢</p>
                </div>
                <div class="stat-card">
                    <h3>${stats.totalUsedQuota.toLocaleString()}</h3>
                    <p>æ€»ä½¿ç”¨é…é¢</p>
                </div>
            `;
        }

        function displayAccountsTable(accounts) {
            const tbody = document.getElementById('accountsTableBody');
            tbody.innerHTML = accounts.map((account, index) => `
                <tr>
                    <td style="text-align: center;">
                        <input type="checkbox" class="account-checkbox" data-email="${account.email}" data-channels='${JSON.stringify(account.channels)}' onchange="updateSelectedCount()">
                    </td>
                    <td class="email-cell">${account.email}</td>
                    <td class="amount-cell">$${account.totalAmount.toFixed(2)}</td>
                    <td>${account.totalChannels}</td>
                    <td>${account.totalUsedQuota.toLocaleString()}</td>
                    <td>
                        <div style="font-size: 0.85em;">
                            <div><strong>æœ€æ—©:</strong> ${new Date(account.oldestChannelTime).toLocaleString()}</div>
                            <div><strong>æœ€æ–°:</strong> ${new Date(account.newestChannelTime).toLocaleString()}</div>
                        </div>
                    </td>
                </tr>
            `).join('');

            // é‡ç½®é€‰æ‹©çŠ¶æ€
            updateSelectedCount();
        }

        function displayMetadata(metadata) {
            const metadataDiv = document.getElementById('metadata');
            // ç²¾ç¡®åˆ°ç§’çš„æ—¶é—´æ ¼å¼
            const formatTimeWithSeconds = (timestamp) => {
                return new Date(timestamp).toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            };

            metadataDiv.innerHTML = `
                <h3>ğŸ“‹ åˆ†æè¯¦æƒ…</h3>
                <div class="metadata-grid">
                    <div class="metadata-item">
                        <strong>æ€»æ¸ é“æ•°:</strong> ${metadata.totalChannelsAnalyzed}
                    </div>
                    <div class="metadata-item">
                        <strong>ç¬¦åˆæ¡ä»¶æ¸ é“:</strong> ${metadata.eligibleChannelsCount}
                    </div>
                    <div class="metadata-item">
                        <strong>æ—¶é—´æˆªæ­¢ç‚¹:</strong> ${formatTimeWithSeconds(metadata.tenHoursAgoTimestamp)} (${metadata.hoursParameter || 10}å°æ—¶å‰)
                    </div>
                    <div class="metadata-item">
                        <strong>å¤„ç†æ—¶é—´:</strong> ${metadata.processingTimeMs}ms
                    </div>
                    <div class="metadata-item">
                        <strong>ç”Ÿæˆæ—¶é—´:</strong> ${formatTimeWithSeconds(metadata.generatedAt)}
                    </div>
                </div>
            `;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
        window.addEventListener('load', () => {
            loadStats();
        });

        // å¯¼å‡ºExcelåŠŸèƒ½
        function exportToExcel() {
            if (!currentData || !currentData.accounts) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡ºï¼Œè¯·å…ˆåˆ·æ–°æ•°æ®');
                return;
            }

            try {
                // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®
                const worksheet = [
                    // è¡¨å¤´
                    ['é‚®ç®±åœ°å€', 'æ€»é‡‘é¢($)', 'æ¸ é“æ€»æ•°', 'ä½¿ç”¨é…é¢', 'æœ€æ—©åˆ›å»ºæ—¶é—´', 'æœ€æ–°åˆ›å»ºæ—¶é—´']
                ];

                // æ·»åŠ æ•°æ®è¡Œ
                currentData.accounts.forEach(account => {
                    worksheet.push([
                        account.email,
                        account.totalAmount.toFixed(2),
                        account.totalChannels,
                        account.totalUsedQuota,
                        new Date(account.oldestChannelTime).toLocaleString('zh-CN'),
                        new Date(account.newestChannelTime).toLocaleString('zh-CN')
                    ]);
                });

                // åˆ›å»ºCSVå†…å®¹
                const csvContent = worksheet.map(row =>
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');

                // æ·»åŠ UTF-8 BOMç”¨äºä¸­æ–‡æ”¯æŒ
                const BOM = '\uFEFF';
                const csvData = BOM + csvContent;

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);

                // ç”Ÿæˆæ–‡ä»¶å
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
                const hours = document.getElementById('timeHours').value || 10;
                link.download = `æ¸ é“ç»Ÿè®¡_${hours}å°æ—¶å‰_${timestamp}.csv`;

                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('Excelå¯¼å‡ºå®Œæˆ');

            } catch (error) {
                console.error('å¯¼å‡ºExcelå¤±è´¥:', error);
                alert(`å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }

        // å…¨é€‰/å–æ¶ˆå…¨é€‰åŠŸèƒ½
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.account-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });

            updateSelectedCount();
        }

        // æ›´æ–°é€‰ä¸­æ•°é‡æ˜¾ç¤º
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.account-checkbox');
            const checkedBoxes = document.querySelectorAll('.account-checkbox:checked');

            // æ›´æ–°è®¡æ•°æ˜¾ç¤º
            const selectedCount = document.getElementById('selectedCount');
            selectedCount.textContent = `å·²é€‰æ‹©: ${checkedBoxes.length} ä¸ªè´¦æˆ·`;

            // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            batchDeleteBtn.disabled = checkedBoxes.length === 0;

            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            const selectAll = document.getElementById('selectAll');
            if (checkedBoxes.length === 0) {
                selectAll.indeterminate = false;
                selectAll.checked = false;
            } else if (checkedBoxes.length === checkboxes.length) {
                selectAll.indeterminate = false;
                selectAll.checked = true;
            } else {
                selectAll.indeterminate = true;
                selectAll.checked = false;
            }
        }

        // æ‰¹é‡åˆ é™¤åŠŸèƒ½ - ä½¿ç”¨æµå¼API
        async function batchDelete() {
            const checkedBoxes = document.querySelectorAll('.account-checkbox:checked');

            if (checkedBoxes.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è´¦æˆ·');
                return;
            }

            // æ”¶é›†é‚®ç®±åˆ—è¡¨
            const emails = [];
            checkedBoxes.forEach(checkbox => {
                const email = checkbox.dataset.email;
                if (!emails.includes(email)) {
                    emails.push(email);
                }
            });

            // ç¡®è®¤å¯¹è¯æ¡†
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${emails.length} ä¸ªè´¦æˆ·ä¸‹çš„æ‰€æœ‰æ¸ é“å—ï¼Ÿ\n\næ¶‰åŠé‚®ç®±:\n${emails.join('\n')}\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // åˆ›å»ºåˆ é™¤è¿›åº¦æ˜¾ç¤º
            const deleteModal = createDeleteProgressModal();
            document.body.appendChild(deleteModal);

            try {
                // ä½¿ç”¨æµå¼åˆ é™¤API
                const response = await fetch('/api/stats/batch-delete-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ emails })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleDeleteProgress(data);
                            } catch (parseError) {
                                console.error('è§£æSSEæ•°æ®å¤±è´¥:', parseError);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
                updateDeleteProgress(`åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ›å»ºåˆ é™¤è¿›åº¦å¼¹çª—
        function createDeleteProgressModal() {
            const modal = document.createElement('div');
            modal.id = 'deleteProgressModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%;">
                    <h3>ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤è¿›åº¦</h3>
                    <div id="deleteStatus" style="margin: 20px 0; font-size: 16px;">å‡†å¤‡åˆ é™¤...</div>

                    <div style="background: #f5f5f5; border-radius: 8px; overflow: hidden; margin: 20px 0;">
                        <div id="deleteProgress" style="background: #007bff; height: 20px; width: 0%; transition: width 0.3s;"></div>
                    </div>

                    <div id="deleteDetails" style="max-height: 200px; overflow-y: auto; font-size: 14px; color: #666; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;"></div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button id="closeDeleteModal" style="display: none;" class="btn btn-secondary" onclick="closeDeleteModal()">å…³é—­</button>
                    </div>
                </div>
            `;

            return modal;
        }

        // å¤„ç†åˆ é™¤è¿›åº¦æ›´æ–°
        function handleDeleteProgress(data) {
            const statusEl = document.getElementById('deleteStatus');
            const progressEl = document.getElementById('deleteProgress');
            const detailsEl = document.getElementById('deleteDetails');

            switch(data.type) {
                case 'connected':
                    statusEl.textContent = data.message;
                    break;

                case 'progress':
                case 'fetch_progress':
                    statusEl.textContent = data.message;
                    if (data.fetchInfo) {
                        detailsEl.innerHTML += `<div>${data.fetchInfo.message}</div>`;
                    }
                    break;

                case 'channels_found':
                    statusEl.textContent = data.message;
                    detailsEl.innerHTML += `<div><strong>ğŸ“‹ å‘ç°è¦åˆ é™¤çš„æ¸ é“: ${data.totalChannels} ä¸ª</strong></div>`;
                    detailsEl.innerHTML += `<div>æ¶‰åŠé‚®ç®±: ${data.emails.join(', ')}</div>`;
                    break;

                case 'delete_success':
                    progressEl.style.width = data.progress + '%';
                    statusEl.textContent = `åˆ é™¤è¿›åº¦: ${data.current}/${data.total} (æˆåŠŸ: ${data.successCount}, å¤±è´¥: ${data.failCount})`;
                    detailsEl.innerHTML += `<div style="color: #28a745;">âœ… ${data.message}</div>`;
                    detailsEl.scrollTop = detailsEl.scrollHeight;
                    break;

                case 'delete_error':
                    progressEl.style.width = data.progress + '%';
                    statusEl.textContent = `åˆ é™¤è¿›åº¦: ${data.current}/${data.total} (æˆåŠŸ: ${data.successCount}, å¤±è´¥: ${data.failCount})`;
                    detailsEl.innerHTML += `<div style="color: #dc3545;">âŒ ${data.message}</div>`;
                    detailsEl.scrollTop = detailsEl.scrollHeight;
                    break;

                case 'complete':
                    progressEl.style.width = '100%';
                    progressEl.style.background = '#28a745';
                    statusEl.textContent = data.message;
                    detailsEl.innerHTML += `<div style="color: #28a745; font-weight: bold;">ğŸ‰ ${data.message}</div>`;

                    // æ˜¾ç¤ºå…³é—­æŒ‰é’®
                    document.getElementById('closeDeleteModal').style.display = 'inline-block';

                    // åˆ·æ–°æ•°æ®
                    if (data.result.successCount > 0) {
                        setTimeout(() => {
                            loadStats();
                        }, 1000);
                    }
                    break;

                case 'error':
                    progressEl.style.background = '#dc3545';
                    statusEl.textContent = `é”™è¯¯: ${data.message}`;
                    detailsEl.innerHTML += `<div style="color: #dc3545; font-weight: bold;">âŒ ${data.message}</div>`;
                    document.getElementById('closeDeleteModal').style.display = 'inline-block';
                    break;
            }
        }

        // å…³é—­åˆ é™¤è¿›åº¦å¼¹çª—
        function closeDeleteModal() {
            const modal = document.getElementById('deleteProgressModal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
    </script>
</body>
</html>