# GCloud Manager é…ç½®åŒ–æ”¹è¿›æ€»ç»“

## ğŸ“‹ é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. âœ… æ•°æ®åº“å­—æ®µç¼ºå¤±é—®é¢˜

**é—®é¢˜**:
- `g_cloud_accounts` è¡¨ç¼ºå°‘ OAuth ç›¸å…³å­—æ®µ
- `gcloud_monitor_logs` è¡¨ç¼ºå°‘ç›‘æ§è¯¦æƒ…å­—æ®µ

**è§£å†³**:
- æ·»åŠ  `fix-db-fields.sql` ä¸º `g_cloud_accounts` æ·»åŠ : `project_name`, `access_token`, `refresh_token`, `token_expiry`, `scopes`, `is_active`
- æ·»åŠ  `fix-monitor-logs-fields.sql` ä¸º `gcloud_monitor_logs` æ·»åŠ : `available_channels`, `tested_channels`, `successful_channels`, `failed_channels`, `disabled_channels`, `script_executed`, `script_type`, `start_time`, `end_time`, `test_details`

### 2. âœ… æ‰§è¡Œå™¨æœåŠ¡ç¡¬ç¼–ç é—®é¢˜

**é—®é¢˜**:
```
Error: Cloud Shell command execution failed: connect ECONNREFUSED 127.0.0.1:3002
```

**åŸå› **: `gcloudMonitorService.js` ä¸­å¤šå¤„ç¡¬ç¼–ç  `http://localhost:3002`

**è§£å†³**:
```javascript
// backend/services/gcloudMonitorService.js
this.executorServiceURL = serviceConfig.executor.serviceUrl;

// docker-compose.prod.yml
EXECUTOR_SERVICE_URL: http://executor-service:3001
```

### 3. âœ… OneAPI æœåŠ¡é…ç½®åŒ–

**é—®é¢˜**: base_url å’Œ api_key æœ‰éƒ¨åˆ†ç¡¬ç¼–ç 

**è§£å†³**: åˆ›å»ºç»Ÿä¸€é…ç½®æ–‡ä»¶ `backend/config/service.config.js`

```javascript
// ä½¿ç”¨å‰
base_url: "http://104.194.9.201:13000"

// ä½¿ç”¨å
base_url: this.geminiChannelBaseUrl  // å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
```

### 4. âœ… GCloud è„šæœ¬é…ç½®åŒ–

**é—®é¢˜**: GitHub è„šæœ¬ä¸‹è½½ URL ç¡¬ç¼–ç 

**è§£å†³**:
```javascript
// backend/config/service.config.js
scriptDownloadUrl: process.env.GCLOUD_SCRIPT_URL || 'https://raw.githubusercontent.com/...'

// docker-compose.prod.yml
GCLOUD_SCRIPT_URL: ${GCLOUD_SCRIPT_URL:-https://...}
GCLOUD_SCRIPT_BACKUP_URL: ${GCLOUD_SCRIPT_BACKUP_URL:-http://...}
```

### 5. âœ… FTP æœåŠ¡æ·»åŠ 

**é—®é¢˜**: ç¼ºå°‘ FTP æœåŠ¡ç”¨äºæ–‡ä»¶ä¸Šä¼ 

**è§£å†³**:
- æ·»åŠ  Pure-FTPd å®¹å™¨
- é…ç½®å…±äº«å· `ftp_data`
- æŒ‚è½½åˆ° main-service ä¾›æ–‡ä»¶ç›‘å¬ä½¿ç”¨
- ç«¯å£: 5021 (FTP), 50000-50009 (è¢«åŠ¨æ¨¡å¼)

### 6. âœ… æ–‡ä»¶ç›‘å¬è·¯å¾„é…ç½®åŒ–

**é—®é¢˜**: è·¯å¾„ç¡¬ç¼–ç  `/home/Chatify/vip`

**è§£å†³**:
```javascript
// backend/services/channelFileMonitor.js
this.monitorPath = process.env.CHANNEL_MONITOR_PATH || '/home/Chatify/vip';

// docker-compose.prod.yml
CHANNEL_MONITOR_PATH: /home/ftpusers/chatify/vip
```

### 7. âœ… Cloud Shell è¶…æ—¶é—®é¢˜ä¿®å¤

**é—®é¢˜**:
```
Error: Cloud Shell command execution failed: timeout of 30000ms exceeded
```

**åŸå› **: å‰ç«¯axioså®ä¾‹å…¨å±€è¶…æ—¶ä»…30ç§’ï¼ŒCloud Shellå‘½ä»¤æ‰§è¡Œæ—¶é—´é€šå¸¸è¾ƒé•¿

**è§£å†³**:
```javascript
// frontend/src/services/api.js
// ä¿®æ”¹å‰
timeout: 30000  // âŒ 30ç§’å¤ªçŸ­

// ä¿®æ”¹å
timeout: 120000  // âœ… 2åˆ†é’Ÿ

// æ–°å¢é•¿è¶…æ—¶å®ä¾‹
export const apiLongRunning = axios.create({
  baseURL: '/api',
  timeout: 10 * 60 * 1000,  // âœ… 10åˆ†é’Ÿï¼Œç”¨äºCloud Shellç­‰é•¿æ—¶é—´æ“ä½œ
  headers: {
    'Content-Type': 'application/json'
  }
});
```

**è¶…æ—¶é…ç½®å±‚æ¬¡**:
- Executor Serviceå†…éƒ¨: 20åˆ†é’Ÿï¼ˆæœ€å®½æ¾ï¼‰
- Main Service â†’ Executor: 5åˆ†é’Ÿ
- Frontend â†’ Backend: 2-10åˆ†é’Ÿï¼ˆæ ¹æ®æ“ä½œç±»å‹ï¼‰

## ğŸ“ æ–°å¢æ–‡ä»¶

### é…ç½®æ–‡ä»¶
```
backend/config/service.config.js     # ç»Ÿä¸€æœåŠ¡é…ç½®
```

### Docker FTP æœåŠ¡
```
docker-prod/ftp/
â”œâ”€â”€ Dockerfile                        # Pure-FTPd é•œåƒ
â””â”€â”€ docker-entrypoint.sh              # FTP å¯åŠ¨è„šæœ¬
```

### æ•°æ®åº“è¿ç§»
```
fix-db-fields.sql                     # GCloud è´¦æˆ·è¡¨å­—æ®µä¿®å¤
fix-monitor-logs-fields.sql           # ç›‘æ§æ—¥å¿—è¡¨å­—æ®µä¿®å¤
backend/scripts/migrate-add-gcloud-auth-fields.js  # JS è¿ç§»è„šæœ¬
```

## ğŸ”§ ä¿®æ”¹çš„æ–‡ä»¶

### æœåŠ¡å±‚
```
backend/services/gcloudMonitorService.js
  âœ… æ·»åŠ  executorServiceURL é…ç½®
  âœ… æ·»åŠ  scriptDownloadUrl å’Œ scriptBackupUrl é…ç½®
  âœ… æ›¿æ¢æ‰€æœ‰ç¡¬ç¼–ç  URL

backend/services/oneApiService.js
  âœ… å¼•å…¥ serviceConfig
  âœ… ä½¿ç”¨é…ç½®åŒ–çš„ base_url
  âœ… æ·»åŠ  geminiChannelBaseUrl é…ç½®

backend/services/channelFileMonitor.js
  âœ… è·¯å¾„æ”¯æŒç¯å¢ƒå˜é‡
  âœ… æˆåŠŸ/å¤±è´¥ç›®å½•åŠ¨æ€é…ç½®

frontend/src/services/api.js
  âœ… å¢åŠ é»˜è®¤è¶…æ—¶åˆ°120ç§’
  âœ… æ–°å¢apiLongRunningå®ä¾‹ï¼ˆ600ç§’ï¼‰
  âœ… ä¸ºä¸¤ä¸ªå®ä¾‹é…ç½®è®¤è¯æ‹¦æˆªå™¨
```

### Docker é…ç½®
```
docker-compose.prod.yml
  âœ… æ·»åŠ  FTP æœåŠ¡
  âœ… æ·»åŠ  ftp_data å·
  âœ… Main æœåŠ¡æŒ‚è½½ FTP å·
  âœ… æ·»åŠ å¤§é‡ç¯å¢ƒå˜é‡é…ç½®
```

## ğŸŒ ç¯å¢ƒå˜é‡åˆ—è¡¨

### æ‰§è¡Œå™¨æœåŠ¡
```bash
EXECUTOR_SERVICE_URL=http://executor-service:3001
```

### OneAPI é…ç½®
```bash
ONEAPI_BASE_URL=http://104.194.9.201:11002
ONEAPI_KEY=t0bAXxyETOitEfEWuU37sWSqwJrE
ONEAPI_GEMINI_BASE_URL=http://104.194.9.201:13000
```

### GCloud è„šæœ¬é…ç½®
```bash
GCLOUD_SCRIPT_URL=https://raw.githubusercontent.com/Chatify-AI/gcloud_server/main/scripts/gcp-put.sh
GCLOUD_SCRIPT_BACKUP_URL=http://82.197.94.152:10086/gcp-put.sh
GCLOUD_SCRIPT_TIMEOUT=180000
GCLOUD_SCRIPT_COOLDOWN=1200000
```

### æ–‡ä»¶ç›‘å¬é…ç½®
```bash
CHANNEL_MONITOR_PATH=/home/ftpusers/chatify/vip
CHANNEL_MONITOR_INTERVAL=5000
```

### FTP é…ç½®
```bash
FTP_HOST=ftp-service
FTP_PORT=21
FTP_USERNAME=chatify
FTP_PASSWORD=chatify123
FTP_PUBLIC_HOST=82.197.94.152
```

## ğŸ“Š æœåŠ¡æ¶æ„æ›´æ–°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker ç½‘ç»œ (172.28.0.0/16)                 â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Nginx   â”‚â”€â”€â”€â†’â”‚ Main Serviceâ”‚           â”‚
â”‚  â”‚ (5080)   â”‚    â”‚   (5000)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                         â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Stats Svc â”‚           â”œâ”€â”€â†’â”‚  MySQL   â”‚   â”‚
â”‚  â”‚ (5001)   â”‚           â”‚   â”‚ (5306)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Executor  â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  Redis   â”‚   â”‚
â”‚  â”‚ (5002)   â”‚               â”‚ (5379)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚FTP Serverâ”‚                               â”‚
â”‚  â”‚ (5021)   â”‚â†â”€ æ–‡ä»¶ä¸Šä¼                     â”‚
â”‚  â”‚50000-50009                               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚       â”‚                                     â”‚
â”‚       â””â”€â”€â†’ FTP_DATA å· â†â”€ Main ç›‘å¬        â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… éƒ¨ç½²çŠ¶æ€

æ‰€æœ‰ 7 ä¸ªæœåŠ¡æ­£å¸¸è¿è¡Œï¼š
- âœ… MySQL (5306)
- âœ… Redis (5379)
- âœ… Main Service (5000)
- âœ… Stats Service (5001)
- âœ… Executor Service (5002)
- âœ… Nginx (5080/5443)
- âœ… FTP Service (5021, 50000-50009)

## ğŸ”‘ FTP è®¿é—®ä¿¡æ¯

```
ä¸»æœº: 82.197.94.152
ç«¯å£: 5021
ç”¨æˆ·å: chatify
å¯†ç : chatify123
ä¸Šä¼ ç›®å½•: /vip
è¢«åŠ¨ç«¯å£èŒƒå›´: 50000-50009
```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ä¿®æ”¹é…ç½®

åˆ›å»º `.env` æ–‡ä»¶ï¼š
```bash
# OneAPI é…ç½®
ONEAPI_BASE_URL=http://your-oneapi.com
ONEAPI_KEY=your-api-key

# GCloud è„šæœ¬
GCLOUD_SCRIPT_URL=https://your-github.com/script.sh

# FTP é…ç½®
FTP_PASSWORD=your-secure-password
```

### é‡å¯æœåŠ¡åº”ç”¨é…ç½®
```bash
docker-compose -f docker-compose.prod.yml up -d
```

## ğŸ¯ ä¼˜åŠ¿

1. **é…ç½®é›†ä¸­ç®¡ç†**: æ‰€æœ‰å¤–éƒ¨æœåŠ¡é…ç½®ç»Ÿä¸€åœ¨ `service.config.js`
2. **å®¹å™¨å‹å¥½**: æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡çµæ´»é…ç½®
3. **æ˜“äºç»´æŠ¤**: æ— éœ€ä¿®æ”¹ä»£ç å³å¯æ›´æ¢æœåŠ¡åœ°å€
4. **å®‰å…¨æ€§**: æ•æ„Ÿä¿¡æ¯å¯é€šè¿‡ `.env` æ–‡ä»¶ç®¡ç†
5. **å¯æ‰©å±•**: ä¾¿äºæ·»åŠ æ–°çš„é…ç½®é¡¹

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Dockeréƒ¨ç½²æ–‡æ¡£](docker-prod/DEPLOYMENT.md)
- [æœåŠ¡é…ç½®è¯´æ˜](backend/config/service.config.js)
- [ç¯å¢ƒå˜é‡é…ç½®](.env.prod)

---

**æ›´æ–°æ—¶é—´**: 2025-10-20
**ä¿®å¤é—®é¢˜**: 8 ä¸ª
**æ–°å¢æœåŠ¡**: FTP Server
**é…ç½®é¡¹**: 15+ ä¸ªç¯å¢ƒå˜é‡
**ä¿®å¤è¶…æ—¶**: Cloud Shell 30ç§’ â†’ 2-10åˆ†é’Ÿ
