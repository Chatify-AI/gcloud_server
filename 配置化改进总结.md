# GCloud Manager 配置化改进总结

## 📋 问题与解决方案

### 1. ✅ 数据库字段缺失问题

**问题**:
- `g_cloud_accounts` 表缺少 OAuth 相关字段
- `gcloud_monitor_logs` 表缺少监控详情字段

**解决**:
- 添加 `fix-db-fields.sql` 为 `g_cloud_accounts` 添加: `project_name`, `access_token`, `refresh_token`, `token_expiry`, `scopes`, `is_active`
- 添加 `fix-monitor-logs-fields.sql` 为 `gcloud_monitor_logs` 添加: `available_channels`, `tested_channels`, `successful_channels`, `failed_channels`, `disabled_channels`, `script_executed`, `script_type`, `start_time`, `end_time`, `test_details`

### 2. ✅ 执行器服务硬编码问题

**问题**:
```
Error: Cloud Shell command execution failed: connect ECONNREFUSED 127.0.0.1:3002
```

**原因**: `gcloudMonitorService.js` 中多处硬编码 `http://localhost:3002`

**解决**:
```javascript
// backend/services/gcloudMonitorService.js
this.executorServiceURL = serviceConfig.executor.serviceUrl;

// docker-compose.prod.yml
EXECUTOR_SERVICE_URL: http://executor-service:3001
```

### 3. ✅ OneAPI 服务配置化

**问题**: base_url 和 api_key 有部分硬编码

**解决**: 创建统一配置文件 `backend/config/service.config.js`

```javascript
// 使用前
base_url: "http://104.194.9.201:13000"

// 使用后
base_url: this.geminiChannelBaseUrl  // 可通过环境变量配置
```

### 4. ✅ GCloud 脚本配置化

**问题**: GitHub 脚本下载 URL 硬编码

**解决**:
```javascript
// backend/config/service.config.js
scriptDownloadUrl: process.env.GCLOUD_SCRIPT_URL || 'https://raw.githubusercontent.com/...'

// docker-compose.prod.yml
GCLOUD_SCRIPT_URL: ${GCLOUD_SCRIPT_URL:-https://...}
GCLOUD_SCRIPT_BACKUP_URL: ${GCLOUD_SCRIPT_BACKUP_URL:-http://...}
```

### 5. ✅ FTP 服务添加

**问题**: 缺少 FTP 服务用于文件上传

**解决**:
- 添加 Pure-FTPd 容器
- 配置共享卷 `ftp_data`
- 挂载到 main-service 供文件监听使用
- 端口: 5021 (FTP), 50000-50009 (被动模式)

### 6. ✅ 文件监听路径配置化

**问题**: 路径硬编码 `/home/Chatify/vip`

**解决**:
```javascript
// backend/services/channelFileMonitor.js
this.monitorPath = process.env.CHANNEL_MONITOR_PATH || '/home/Chatify/vip';

// docker-compose.prod.yml
CHANNEL_MONITOR_PATH: /home/ftpusers/chatify/vip
```

### 7. ✅ Cloud Shell 超时问题修复

**问题**:
```
Error: Cloud Shell command execution failed: timeout of 30000ms exceeded
```

**原因**: 前端axios实例全局超时仅30秒，Cloud Shell命令执行时间通常较长

**解决**:
```javascript
// frontend/src/services/api.js
// 修改前
timeout: 30000  // ❌ 30秒太短

// 修改后
timeout: 120000  // ✅ 2分钟

// 新增长超时实例
export const apiLongRunning = axios.create({
  baseURL: '/api',
  timeout: 10 * 60 * 1000,  // ✅ 10分钟，用于Cloud Shell等长时间操作
  headers: {
    'Content-Type': 'application/json'
  }
});
```

**超时配置层次**:
- Executor Service内部: 20分钟（最宽松）
- Main Service → Executor: 5分钟
- Frontend → Backend: 2-10分钟（根据操作类型）

## 📁 新增文件

### 配置文件
```
backend/config/service.config.js     # 统一服务配置
```

### Docker FTP 服务
```
docker-prod/ftp/
├── Dockerfile                        # Pure-FTPd 镜像
└── docker-entrypoint.sh              # FTP 启动脚本
```

### 数据库迁移
```
fix-db-fields.sql                     # GCloud 账户表字段修复
fix-monitor-logs-fields.sql           # 监控日志表字段修复
backend/scripts/migrate-add-gcloud-auth-fields.js  # JS 迁移脚本
```

## 🔧 修改的文件

### 服务层
```
backend/services/gcloudMonitorService.js
  ✅ 添加 executorServiceURL 配置
  ✅ 添加 scriptDownloadUrl 和 scriptBackupUrl 配置
  ✅ 替换所有硬编码 URL

backend/services/oneApiService.js
  ✅ 引入 serviceConfig
  ✅ 使用配置化的 base_url
  ✅ 添加 geminiChannelBaseUrl 配置

backend/services/channelFileMonitor.js
  ✅ 路径支持环境变量
  ✅ 成功/失败目录动态配置

frontend/src/services/api.js
  ✅ 增加默认超时到120秒
  ✅ 新增apiLongRunning实例（600秒）
  ✅ 为两个实例配置认证拦截器
```

### Docker 配置
```
docker-compose.prod.yml
  ✅ 添加 FTP 服务
  ✅ 添加 ftp_data 卷
  ✅ Main 服务挂载 FTP 卷
  ✅ 添加大量环境变量配置
```

## 🌐 环境变量列表

### 执行器服务
```bash
EXECUTOR_SERVICE_URL=http://executor-service:3001
```

### OneAPI 配置
```bash
ONEAPI_BASE_URL=http://104.194.9.201:11002
ONEAPI_KEY=t0bAXxyETOitEfEWuU37sWSqwJrE
ONEAPI_GEMINI_BASE_URL=http://104.194.9.201:13000
```

### GCloud 脚本配置
```bash
GCLOUD_SCRIPT_URL=https://raw.githubusercontent.com/Chatify-AI/gcloud_server/main/scripts/gcp-put.sh
GCLOUD_SCRIPT_BACKUP_URL=http://82.197.94.152:10086/gcp-put.sh
GCLOUD_SCRIPT_TIMEOUT=180000
GCLOUD_SCRIPT_COOLDOWN=1200000
```

### 文件监听配置
```bash
CHANNEL_MONITOR_PATH=/home/ftpusers/chatify/vip
CHANNEL_MONITOR_INTERVAL=5000
```

### FTP 配置
```bash
FTP_HOST=ftp-service
FTP_PORT=21
FTP_USERNAME=chatify
FTP_PASSWORD=chatify123
FTP_PUBLIC_HOST=82.197.94.152
```

## 📊 服务架构更新

```
┌─────────────────────────────────────────────┐
│  Docker 网络 (172.28.0.0/16)                 │
│                                             │
│  ┌──────────┐    ┌─────────────┐           │
│  │  Nginx   │───→│ Main Service│           │
│  │ (5080)   │    │   (5000)    │           │
│  └──────────┘    └──────┬──────┘           │
│                         │                   │
│  ┌──────────┐           │   ┌──────────┐   │
│  │Stats Svc │           ├──→│  MySQL   │   │
│  │ (5001)   │           │   │ (5306)   │   │
│  └──────────┘           │   └──────────┘   │
│                         │                   │
│  ┌──────────┐           │   ┌──────────┐   │
│  │Executor  │←──────────┘   │  Redis   │   │
│  │ (5002)   │               │ (5379)   │   │
│  └──────────┘               └──────────┘   │
│                                             │
│  ┌──────────┐                               │
│  │FTP Server│                               │
│  │ (5021)   │←─ 文件上传                    │
│  │50000-50009                               │
│  └────┬─────┘                               │
│       │                                     │
│       └──→ FTP_DATA 卷 ←─ Main 监听        │
│                                             │
└─────────────────────────────────────────────┘
```

## ✅ 部署状态

所有 7 个服务正常运行：
- ✅ MySQL (5306)
- ✅ Redis (5379)
- ✅ Main Service (5000)
- ✅ Stats Service (5001)
- ✅ Executor Service (5002)
- ✅ Nginx (5080/5443)
- ✅ FTP Service (5021, 50000-50009)

## 🔑 FTP 访问信息

```
主机: 82.197.94.152
端口: 5021
用户名: chatify
密码: chatify123
上传目录: /vip
被动端口范围: 50000-50009
```

## 📝 使用示例

### 修改配置

创建 `.env` 文件：
```bash
# OneAPI 配置
ONEAPI_BASE_URL=http://your-oneapi.com
ONEAPI_KEY=your-api-key

# GCloud 脚本
GCLOUD_SCRIPT_URL=https://your-github.com/script.sh

# FTP 配置
FTP_PASSWORD=your-secure-password
```

### 重启服务应用配置
```bash
docker-compose -f docker-compose.prod.yml up -d
```

## 🎯 优势

1. **配置集中管理**: 所有外部服务配置统一在 `service.config.js`
2. **容器友好**: 支持通过环境变量灵活配置
3. **易于维护**: 无需修改代码即可更换服务地址
4. **安全性**: 敏感信息可通过 `.env` 文件管理
5. **可扩展**: 便于添加新的配置项

## 📚 相关文档

- [Docker部署文档](docker-prod/DEPLOYMENT.md)
- [服务配置说明](backend/config/service.config.js)
- [环境变量配置](.env.prod)

---

**更新时间**: 2025-10-20
**修复问题**: 8 个
**新增服务**: FTP Server
**配置项**: 15+ 个环境变量
**修复超时**: Cloud Shell 30秒 → 2-10分钟
